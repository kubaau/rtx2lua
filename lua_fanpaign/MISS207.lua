-- Generation begin (https://github.com/kubaau/rtx2lua)

-- Original map script: MIS_0007.RTX

rttr:RegisterTranslations(
{
    de =
    {
        Diary   = 'Tagebuch',
        msg0    = 'Einöde - Mission von Achim Ruziczka\n\nDieses Mal haben sich die Götter wohl einen gemeinen Scherz mit uns erlaubt. Das Tor liegt zum Greifen nahe, doch uns trennt ein See von ihm. Noch ist nicht abzusehen, wie wir das Tor erreichen können, doch wenn die Götter uns das Tor stets vor Augen halten, werden Sie uns wohl narren wollen. Hoffen wir, daß ein gangbarer Weg bald gefunden wird. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n',
        msgh0   = 'Es besteht die Möglichkeit zum Hafenbau, finde den verborgenen Hafen, und setze zum Tor über! ',
        msg2    = 'Eine weites fruchtbares Tal  erstreckt sich vor uns. Die Eingeborenen die im Tal leben scheinen sehr friedlich zu sein. Dieses Tal wird von hohen Bergen beschützt, deshalb hat es diese üppige Vegetation. Wir müssen in einer Einöde fristen, stets dem kalten Seewind ausgesetzt. Die Eingeborenen erzählen uns von einem seltsamen Berg,  er besteht aus brennbarer schwarzer Erde. Es könnte Kohle sein, die wir so dringend benötigen. Militärisch scheinen sie nicht allzu stark zu sein, wenn wir die Kohle wollen, werden wir aber kämpfen müssen. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n',
        msgh2   = 'Überlege was Du tust, oft narren einen auch die Götter. Man zerstört was man dringend braucht, ohne zu wissen was man eigentlich tut!',
        msg4    = 'Ein weiteres Tal!\n\nAuch dieses ist besiedelt. So wie das Tal verläuft, könnte von hier aus ein direkter Weg zum Tor bestehen. Doch die Eingeborenen lassen uns nicht friedlich durch Ihr Land ziehen. Sie erzählen von einem Ort, der mit einem Tabu belegt ist. Keiner darf ihn je betreten - sonst wird man von der Erde verschlungen, und kommt nie wieder.\nEs hört sich so an, als sei es wirklich der Weg zum Tor!\nDoch den Weg über Land hätten Ihre Ahnen zerstört, um weiteres Unheil abzuwenden.\n\nKönnen wir Ihnen trauen?\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n',
        msgh4   = 'Sollen wir Ihnen glauben, wer wird so töricht sein, und einen gangbaren Weg zerstören? Leider sind diese Eingeborenen bis zu den Zähnen bewaffnet, wir sollten uns für "DIESEN" Weg also auf alle Fälle rüsten!',
        msg6    = 'Umsonst gekämpft?\n\nDie Eingeborenen haben die Wahrheit gesprochen. Hier gibt es keine Passage zum Tor. Nun bleibt uns nur noch die Hoffnung, bald den von den Göttern versprochenen Hafen zu finden. Doch aus Ihren Hinweisen werden wir nicht schlau.\n\nEr sei, wie das Tor auch, von Anfang an sichtbar, doch keiner wird verstehen was er sieht. Noch den Weg "ALLEINE" dahin finden!\n\nWas wollen uns die Götter damit sagen? \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n',
        msgh6   = 'Finde den verborgenen Hafen, nur über Ihn ist das Tor erreichbar! Denke daran, so wie es die Götter beschreiben, siehst Du den Bauplatz für den Hafen  von Anfang an, nur "ALLEINE" kannst Du Ihn nicht erreichen!',
        msg8    = 'Wir haben das Tor erreicht, und bestetzt.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n',
        msgh8   = 'Sie haben diese Mission erfüllt! Es warten neue Abenteuer, die bestanden werden wollen!',
    },
    en =
    {
        Diary   = 'Diary',
        msg0    = "Desert\na mission by Achim Ruziczka\n\nThis time the gods seem to have played a very dirty trick on us. \n\nThe Gate is within plain sight, but there is a lake separating us from it. We don't know yet, how we can reach The Gate, but when the gods put it within sight, they most probably will make fools of us. \n\nLets hope, that a way will be found soon. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        msgh0   = 'There is a possibility to build a harbour. Find the hidden Harbour and ferry over! ',
        msg2    = "In the Southeast there is a fertile valley. The aborigines living there are very peaceful.  This valley is screened by huge mountains, hence its luscious vegetation. \nWe have to bear with a barren desert, swept by harsh sea winds and the soil is that poor, that nothing grows in it. \n\nThe aborigines tell us about a strange mountain, consisting of combustible black stones. This could be the coal we dearly need. They don't seem to be much of a military challenge. If we want the coal, we have to pass their land. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        msgh2   = "Think twice what you are about to do. More often than not the gods are fooling man. And easily is destroyed what you need dearly, if you don't care\nwhat you turn loose in your\nthoughtless zeal!",
        msg4    = "Another valley lies to the Southwest! It's also inhabited. Both tribes on this island seem to be related very closely.\n\nThe way this valley extends, it could be a direct access to The Gate. We have been told about a place inflicted with a taboo. No one is ever to enter it - or will be swallowed by the ground, never to return.\nThis sounds as if there is a direct access to The Gate!\nBut their ancestors are said to have destroyed this way over land to avert further harm.\n\nAre they trustworthy?\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        msgh4   = 'Shall we trust them? Who will be that stupid to destroy a practicable way? They seem to be armed up to their teeth. We should prepare ourselves in any\ncase, if we decide to take THIS\nway!',
        msg6    = "Fought in vain?\n\nThe aborigines have told us the truth, after all. There is no passage to The Gate. Now our only hope remains to soon find the harbour-place, the gods have promised. But the meaning of their directions is obscure.\n\nLike The Gate, the place should be obvious, but no one would recognize, what he sees. Nor will he find the way there 'ALL BY HIMSELF'!\n\nWhat do the gods intend to tell us with this?\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        msgh6   = "Find the hidden harbour. Only by sea The Gate can be reached! Bear in mind the words of the Gods:\n\n'ALL BY YOURSELF' you will never\nreach it!",
        msg8    = '\n\n\n\n\n\nWe have reached and occupied The Gate.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n',
        msgh8   = 'You successfully reached the end of this mission! But there are new challenges awaiting you in your quest!',
    },
})

function getNumPlayers()
    return 3
end

-- boilerplate begin
function getRequiredLuaVersion()
    return 1
end

function isMapPreviewEnabled()
    return false
end

local requiredFeature = 4
function checkVersion()
    local featureLevel = rttr:GetFeatureLevel()
    if featureLevel < requiredFeature then
        rttr:MsgBox("LUA-Version Error", "Your Return to the Roots version is outdated. The required LUA-Feature level is " .. requiredFeature .. ", your version is " .. featureLevel .. ". The script can possibly crash or run unexpectedly!\n\nPlease update the game!", true)
    end
end

local isLoading = false
function showMissionText(e)
    if isLoading then return end

    local msg = _('msg' .. tostring(e))

    if msg ~= ('msg' .. tostring(e)) then
        local msgh = _('msgh' .. tostring(e))
        if msgh ~= ('msgh'.. tostring(e)) then
            rttr:MissionStatement(0, _('Diary'), msg .. '\n\n\n\n' .. msgh)
            rttr:SetMissionGoal(0, msgh)
        else
            rttr:MissionStatement(0, _('Diary'), msg)
        end
    else
        rttr:Log("Error: no Translation found: " .. msg)
    end
end

function enableBuilding(b)
    rttr:GetPlayer(0):EnableBuilding(b, not isLoading)
end

function getAllowedChanges()
    return
    {
        ["addonsAll"]   = false,
        ["ownNation"]   = false,
        ["ownColor"]    = false,
        ["ownTeam"]     = false,
        ["aiNation"]    = false,
        ["aiColor"]     = false,
        ["aiTeam"]      = false,
    }
end

local activeEvents = {}
local eventHistory = {}
local timesTriggered = {}

function onSave(saveGame)
    saveGame:PushInt(#eventHistory)
    for i = 1, #eventHistory do
        saveGame:PushInt(eventHistory[i])
    end
    return true
end

function onLoad(saveGame)
    local n = saveGame:PopInt()
    for i = 1, n do
        eventHistory[i] = saveGame:PopInt()
    end
    return true
end

function onSettingsReady()
    checkVersion()
    rttr:Log("-----------------------\n lua loaded... \n-----------------------\n")
    rttr:ResetAddons()
    rttr:SetAddon(ADDON_CATAPULTS_ATTACK_ALLIES, true)
    rttr:SetAddon(ADDON_FRONTIER_DISTANCE_REACHABLE, true)
    rttr:SetGameSettings({
        ["fow"] = EXP_CLASSIC,
        ["teamView"] = false,
        ["lockedTeams"] = false
    })

    rttr:GetPlayer(0):SetNation(NAT_ROMANS)
    rttr:GetPlayer(0):SetColor(0)
-- boilerplate end

    rttr:GetPlayer(1):SetAI(3)
    rttr:GetPlayer(1):SetColor(1)
    rttr:GetPlayer(1):SetNation(NAT_AFRICANS)
    rttr:GetPlayer(1):SetName('Mnga Tscha')
 -- rttr:GetPlayer(1):SetPortrait(11)

    rttr:GetPlayer(2):SetAI(3)
    rttr:GetPlayer(2):SetColor(2)
    rttr:GetPlayer(2):SetNation(NAT_AFRICANS)
    rttr:GetPlayer(2):SetName('Todo')
 -- rttr:GetPlayer(2):SetPortrait(10)
end

function onStart(isFirstStart)
    -- world always commands
    rttr:GetWorld():SetComputerBarrier(20, 60, 50)

    -- player 0 always commands
    rttr:GetPlayer(0):DisableAllBuildings()
    rttr:GetPlayer(0):EnableAllBuildings()

    -- player 1 always commands
    rttr:GetPlayer(1):EnableAllBuildings()

    -- player 2 always commands
    rttr:GetPlayer(2):EnableAllBuildings()

    -- events which need to be triggered multiple times

    -- events which are active right from the start
    activeEvents[ 0] = true
    activeEvents[10] = true
    activeEvents[11] = true
    activeEvents[20] = true
    activeEvents[23] = true
    activeEvents[30] = true
    activeEvents[50] = true
    activeEvents[99] = true

    if isFirstStart then
        -- world firststart commands

        -- player 0 firststart commands
        rttr:GetPlayer(0):MakeOneSidedAllianceTo(1)
        rttr:GetPlayer(0):MakeOneSidedAllianceTo(2)
        rttr:GetPlayer(0):PlaceHQ(71, 35)
        rttr:GetPlayer(0):ClearResources()

        -- player 1 firststart commands
        rttr:GetPlayer(1):MakeOneSidedAllianceTo(0)
        rttr:GetPlayer(1):MakeOneSidedAllianceTo(2)
        rttr:GetPlayer(1):PlaceHQ(34, 42)
        rttr:GetPlayer(1):AIConstructionOrder(40, 42, BLD_FORTRESS)
        rttr:GetPlayer(1):AIConstructionOrder(37, 48, BLD_FORTRESS)
        rttr:GetPlayer(1):ClearResources()

        -- player 2 firststart commands
        rttr:GetPlayer(2):MakeOneSidedAllianceTo(0)
        rttr:GetPlayer(2):MakeOneSidedAllianceTo(1)
        rttr:GetPlayer(2):PlaceHQ(103, 55)
        rttr:GetPlayer(2):AIConstructionOrder(98, 61, BLD_FORTRESS)
        rttr:GetPlayer(2):AIConstructionOrder(95, 55, BLD_FORTRESS)
        rttr:GetPlayer(2):AIConstructionOrder(98, 49, BLD_FORTRESS)
        rttr:GetPlayer(2):ClearResources()

        -- player 0 wares
        rttr:GetPlayer(0):AddWares({
            [GD_WOOD      ] = 100,
            [GD_BOARDS    ] = 100,
            [GD_STONES    ] = 100,
            [GD_MEAT      ] = 0,
            [GD_GRAIN     ] = 100,
            [GD_FLOUR     ] = 0,
            [GD_FISH      ] = 20,
            [GD_HAM       ] = 20,
            [GD_BREAD     ] = 20,
            [GD_WATER     ] = 50,
            [GD_BEER      ] = 0,
            [GD_COAL      ] = 0,
            [GD_IRONORE   ] = 100,
            [GD_GOLD      ] = 100,
            [GD_IRON      ] = 100,
            [GD_COINS     ] = 10,
            [GD_TONGS     ] = 0,
            [GD_AXE       ] = 0,
            [GD_SAW       ] = 0,
            [GD_PICKAXE   ] = 0,
            [GD_HAMMER    ] = 0,
            [GD_SHOVEL    ] = 0,
            [GD_CRUCIBLE  ] = 0,
            [GD_RODANDLINE] = 0,
            [GD_SCYTHE    ] = 0,
            [GD_CLEAVER   ] = 0,
            [GD_ROLLINGPIN] = 0,
            [GD_BOW       ] = 0,
            [GD_SWORD     ] = 0,
            [GD_SHIELD    ] = 0,
            [GD_BOAT      ] = 0,
        })

        -- player 1 wares
        rttr:GetPlayer(1):AddWares({
            [GD_WOOD      ] = 0,
            [GD_BOARDS    ] = 100,
            [GD_STONES    ] = 200,
            [GD_MEAT      ] = 0,
            [GD_GRAIN     ] = 0,
            [GD_FLOUR     ] = 0,
            [GD_FISH      ] = 0,
            [GD_HAM       ] = 0,
            [GD_BREAD     ] = 0,
            [GD_WATER     ] = 0,
            [GD_BEER      ] = 0,
            [GD_COAL      ] = 0,
            [GD_IRONORE   ] = 0,
            [GD_GOLD      ] = 0,
            [GD_IRON      ] = 0,
            [GD_COINS     ] = 0,
            [GD_TONGS     ] = 0,
            [GD_AXE       ] = 0,
            [GD_SAW       ] = 0,
            [GD_PICKAXE   ] = 0,
            [GD_HAMMER    ] = 0,
            [GD_SHOVEL    ] = 0,
            [GD_CRUCIBLE  ] = 0,
            [GD_RODANDLINE] = 0,
            [GD_SCYTHE    ] = 0,
            [GD_CLEAVER   ] = 0,
            [GD_ROLLINGPIN] = 0,
            [GD_BOW       ] = 0,
            [GD_SWORD     ] = 0,
            [GD_SHIELD    ] = 0,
            [GD_BOAT      ] = 0,
        })

        -- player 2 wares
        rttr:GetPlayer(2):AddWares({
            [GD_WOOD      ] = 0,
            [GD_BOARDS    ] = 200,
            [GD_STONES    ] = 200,
            [GD_MEAT      ] = 0,
            [GD_GRAIN     ] = 0,
            [GD_FLOUR     ] = 0,
            [GD_FISH      ] = 0,
            [GD_HAM       ] = 0,
            [GD_BREAD     ] = 0,
            [GD_WATER     ] = 0,
            [GD_BEER      ] = 0,
            [GD_COAL      ] = 0,
            [GD_IRONORE   ] = 0,
            [GD_GOLD      ] = 0,
            [GD_IRON      ] = 0,
            [GD_COINS     ] = 0,
            [GD_TONGS     ] = 0,
            [GD_AXE       ] = 0,
            [GD_SAW       ] = 0,
            [GD_PICKAXE   ] = 0,
            [GD_HAMMER    ] = 0,
            [GD_SHOVEL    ] = 0,
            [GD_CRUCIBLE  ] = 0,
            [GD_RODANDLINE] = 0,
            [GD_SCYTHE    ] = 0,
            [GD_CLEAVER   ] = 0,
            [GD_ROLLINGPIN] = 0,
            [GD_BOW       ] = 0,
            [GD_SWORD     ] = 0,
            [GD_SHIELD    ] = 0,
            [GD_BOAT      ] = 0,
        })

        -- player 0 people
        rttr:GetPlayer(0):AddPeople({
            [JOB_HELPER           ] = 50,
            [JOB_WOODCUTTER       ] = 10,
            [JOB_FISHER           ] = 10,
            [JOB_FORESTER         ] = 3,
            [JOB_CARPENTER        ] = 4,
            [JOB_STONEMASON       ] = 2,
            [JOB_HUNTER           ] = 5,
            [JOB_FARMER           ] = 10,
            [JOB_MILLER           ] = 5,
            [JOB_BAKER            ] = 5,
            [JOB_BUTCHER          ] = 5,
            [JOB_MINER            ] = 5,
            [JOB_BREWER           ] = 5,
            [JOB_PIGBREEDER       ] = 5,
            [JOB_DONKEYBREEDER    ] = 5,
            [JOB_IRONFOUNDER      ] = 5,
            [JOB_MINTER           ] = 5,
            [JOB_METALWORKER      ] = 5,
            [JOB_ARMORER          ] = 5,
            [JOB_BUILDER          ] = 10,
            [JOB_PLANER           ] = 5,
            [JOB_GEOLOGIST        ] = 5,
            [JOB_PRIVATE          ] = 20,
            [JOB_PRIVATEFIRSTCLASS] = 5,
            [JOB_SERGEANT         ] = 50,
            [JOB_OFFICER          ] = 5,
            [JOB_GENERAL          ] = 5,
            [JOB_SCOUT            ] = 10,
            [JOB_SHIPWRIGHT       ] = 2,
            [JOB_PACKDONKEY       ] = 20,
            [JOB_BOATCARRIER      ] = 0,
            [JOB_CHARBURNER       ] = 0,
        })

        -- player 1 people
        rttr:GetPlayer(1):AddPeople({
            [JOB_HELPER           ] = 50,
            [JOB_WOODCUTTER       ] = 15,
            [JOB_FISHER           ] = 10,
            [JOB_FORESTER         ] = 10,
            [JOB_CARPENTER        ] = 10,
            [JOB_STONEMASON       ] = 10,
            [JOB_HUNTER           ] = 5,
            [JOB_FARMER           ] = 10,
            [JOB_MILLER           ] = 5,
            [JOB_BAKER            ] = 5,
            [JOB_BUTCHER          ] = 5,
            [JOB_MINER            ] = 20,
            [JOB_BREWER           ] = 5,
            [JOB_PIGBREEDER       ] = 5,
            [JOB_DONKEYBREEDER    ] = 5,
            [JOB_IRONFOUNDER      ] = 10,
            [JOB_MINTER           ] = 15,
            [JOB_METALWORKER      ] = 5,
            [JOB_ARMORER          ] = 10,
            [JOB_BUILDER          ] = 4,
            [JOB_PLANER           ] = 4,
            [JOB_GEOLOGIST        ] = 5,
            [JOB_PRIVATE          ] = 10,
            [JOB_PRIVATEFIRSTCLASS] = 10,
            [JOB_SERGEANT         ] = 10,
            [JOB_OFFICER          ] = 20,
            [JOB_GENERAL          ] = 50,
            [JOB_SCOUT            ] = 10,
            [JOB_SHIPWRIGHT       ] = 0,
            [JOB_PACKDONKEY       ] = 20,
            [JOB_BOATCARRIER      ] = 0,
            [JOB_CHARBURNER       ] = 0,
        })

        -- player 2 people
        rttr:GetPlayer(2):AddPeople({
            [JOB_HELPER           ] = 50,
            [JOB_WOODCUTTER       ] = 15,
            [JOB_FISHER           ] = 10,
            [JOB_FORESTER         ] = 10,
            [JOB_CARPENTER        ] = 10,
            [JOB_STONEMASON       ] = 10,
            [JOB_HUNTER           ] = 5,
            [JOB_FARMER           ] = 10,
            [JOB_MILLER           ] = 5,
            [JOB_BAKER            ] = 5,
            [JOB_BUTCHER          ] = 5,
            [JOB_MINER            ] = 20,
            [JOB_BREWER           ] = 5,
            [JOB_PIGBREEDER       ] = 5,
            [JOB_DONKEYBREEDER    ] = 5,
            [JOB_IRONFOUNDER      ] = 10,
            [JOB_MINTER           ] = 15,
            [JOB_METALWORKER      ] = 5,
            [JOB_ARMORER          ] = 10,
            [JOB_BUILDER          ] = 20,
            [JOB_PLANER           ] = 10,
            [JOB_GEOLOGIST        ] = 5,
            [JOB_PRIVATE          ] = 50,
            [JOB_PRIVATEFIRSTCLASS] = 30,
            [JOB_SERGEANT         ] = 8,
            [JOB_OFFICER          ] = 5,
            [JOB_GENERAL          ] = 3,
            [JOB_SCOUT            ] = 10,
            [JOB_SHIPWRIGHT       ] = 0,
            [JOB_PACKDONKEY       ] = 20,
            [JOB_BOATCARRIER      ] = 0,
            [JOB_CHARBURNER       ] = 0,
        })

        -- events which are triggered right from the start
        triggerEndEvent(0, 0)
    else
        isLoading = true
        for i = 1, #eventHistory, 2 do
            triggerEndEvent(eventHistory[i], eventHistory[i + 1])
        end
        isLoading = false
    end
end

function triggerEndEvent(e, trigger) -- events triggered from other events
    if not activeEvents[e] then return end

    if timesTriggered[e] then timesTriggered[e] = timesTriggered[e] + 1 end

    if false then -- dummy if
    elseif e == 0 then
        showMissionText(0)
    elseif e == 50 then
        rttr:GetWorld():AddStaticObject(71, 24, 560, 0xFFFF, 2)
    elseif e == 98 then
        rttr:GetWorld():AddStaticObject(71, 24, 561, 0xFFFF, 2)
    elseif e == 99 then
        activeEvents[98] = true
        showMissionText(8)
        rttr:SetCampaignChapterCompleted('FANpaign', 8)
        rttr:EnableCampaignChapter('FANpaign', 9)
    end

    if not isLoading then
        local n = #eventHistory
        eventHistory[n + 1] = e
        eventHistory[n + 2] = trigger
    end

    activeEvents[trigger] = false
end

function onGameFrame(gf)
    if activeEvents[50] then
        triggerEndEvent(50, 50)
    end
    if activeEvents[98] then
        triggerEndEvent(98, 98)
    end
end

function onExplored(p, x, y, o)
    if false then -- dummy if for onContact cases
    elseif activeEvents[10] and ((p == 0 and o == 2) or (p == 2 and o == 0)) then
        showMissionText(2)
        triggerEndEvent(10, 10)
    elseif activeEvents[11] and ((p == 0 and o == 1) or (p == 1 and o == 0)) then
        showMissionText(4)
        triggerEndEvent(11, 11)
    end

    if p ~= 0 then return
    elseif activeEvents[20] and x == 48 and y == 20 then
        showMissionText(6)
        triggerEndEvent(20, 20)
    end
end

function onOccupied(p, x, y)
    if p ~= 0 then return
    elseif activeEvents[30] and x == 70 and y == 23 then
        triggerEndEvent(30, 30)
        triggerEndEvent(99, 30)
    end
end

function onResourceFound(p, x, y, r, q)
    if p ~= 0 then return
    end
end

-- Generation end
